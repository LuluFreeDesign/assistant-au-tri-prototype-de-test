<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L'assistant au tri, au réemploi et à la réparation</title>
  <link rel="stylesheet" href="src/css/fonts.css">
  <style>
    /* ============================================
       DSFR-based Design Tokens
       ============================================ */
    :root {
      /* Couleurs DSFR */
      --blue-france: #000091;
      --blue-france-hover: #1212FF;
      --blue-france-active: #2323FF;
      --red-marianne: #E1000F;

      /* Couleurs fonctionnelles */
      --text-default: #161616;
      --text-mention-grey: #666666;
      --text-label-grey: #3A3A3A;
      --text-inverted: #FFFFFF;

      --background-default: #FFFFFF;
      --background-alt-grey: #F6F6F6;
      --background-contrast-grey: #EEEEEE;
      --background-action-low-blue: #F5F5FE;

      --border-default: #DDDDDD;
      --border-plain: #CECECE;
      --border-active-blue: #000091;

      /* Couleurs DSFR - Green Menthe */
      --green-menthe-975: #dffdf7;
      --green-menthe-sun-373: #37635f;
      --green-menthe-main: #009081;

      /* Espacement DSFR (multiples de 4px) */
      --spacing-1v: 0.25rem;   /* 4px */
      --spacing-2v: 0.5rem;    /* 8px */
      --spacing-3v: 0.75rem;   /* 12px */
      --spacing-4v: 1rem;      /* 16px */
      --spacing-5v: 1.25rem;   /* 20px */
      --spacing-6v: 1.5rem;    /* 24px */
      --spacing-7v: 1.75rem;   /* 28px */
      --spacing-8v: 2rem;      /* 32px */
      --spacing-9v: 2.25rem;   /* 36px */
      --spacing-10v: 2.5rem;   /* 40px */
      --spacing-12v: 3rem;     /* 48px */

      /* Ombres */
      --shadow-raised: 0 2px 6px 0 rgba(0, 0, 18, 0.16);
      --shadow-overlap: 0 4px 12px 0 rgba(0, 0, 18, 0.16);

      /* Rayons */
      --radius-sm: 0.25rem;
      --radius-md: 0.5rem;
    }

    /* ============================================
       Reset & Base
       ============================================ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      overflow-x: hidden;
    }

    body {
      font-family: 'Marianne', arial, sans-serif;
      color: var(--text-default);
      background-color: var(--background-default);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }

    /* ============================================
       Layout principal de l'iframe
       ============================================ */
    .iframe-container {
      width: 100%;
      max-width: 900px;
      min-width: 260px;
      margin: 0 auto;
      overflow-wrap: break-word;
      word-wrap: break-word;
      border: 2px solid #4f9d91;
      border-radius: 4px;
      overflow: hidden;
    }

    /* ============================================
       Section Recherche (Hero)
       ============================================ */
    .search-section {
      background-color: var(--green-menthe-975);
      padding: var(--spacing-6v) var(--spacing-4v) 0;
      position: relative;
    }

    .search-section__title {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.5;
      color: var(--text-default);
      margin-bottom: var(--spacing-4v);
    }

    /* Barre de recherche custom */
    .search-bar {
      position: relative;
      display: flex;
      align-items: center;
      background-color: var(--background-default);
      border: 2px solid var(--green-menthe-sun-373);
      border-radius: var(--radius-sm);
      transition: border-color 0.2s ease;
      cursor: text;
    }

    .search-bar:focus-within {
      border-color: var(--green-menthe-sun-373);
      outline: 2px solid var(--green-menthe-sun-373);
      outline-offset: -2px;
    }

    .search-bar__icon {
      display: flex;
      align-items: center;
      justify-content: center;
      padding-left: var(--spacing-3v);
      color: var(--green-menthe-sun-373);
      flex-shrink: 0;
    }

    .search-bar__icon svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    .search-bar__input {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      padding: var(--spacing-3v) var(--spacing-3v);
      font-family: 'Marianne', arial, sans-serif;
      font-size: 1rem;
      color: var(--text-default);
      outline: none;
    }

    .search-bar__input::placeholder {
      color: var(--text-mention-grey);
      font-style: italic;
    }

    /* ============================================
       Panneau de recherche (overlay)
       ============================================ */
    .search-panel {
      display: none;
      background-color: var(--background-default);
      padding: 0 var(--spacing-4v) var(--spacing-4v);
      animation: slideDown 0.25s ease-out;
    }

    .search-panel.is-open {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Bouton fermer recherche — positionné en haut à droite de search-section */
    .search-section__close {
      display: none; /* Visible uniquement quand search-active */
      position: absolute;
      top: var(--spacing-2v);
      right: var(--spacing-2v);
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      background: none;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-mention-grey);
      transition: background-color 0.15s ease, color 0.15s ease;
      z-index: 20;
    }

    .iframe-container.search-active .search-section__close {
      display: flex;
    }

    .search-section__close:hover {
      background-color: var(--background-contrast-grey);
      color: var(--text-default);
    }

    .search-section__close:focus-visible {
      outline: 2px solid var(--green-menthe-sun-373);
      outline-offset: 2px;
    }

    .search-section__close svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    .search-panel__hint {
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--text-mention-grey);
      padding: 0 0 var(--spacing-4v);
    }

    /* Résultats de recherche */
    .search-results {
      display: none;
      list-style: none;
    }

    .search-results.is-visible {
      display: block;
    }

    .search-results__item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-3v) var(--spacing-1v);
      border-bottom: 1px solid var(--border-default);
      cursor: pointer;
      font-size: 0.9375rem;
      color: var(--text-default);
      transition: background-color 0.15s ease;
    }

    .search-results__item:hover {
      background-color: var(--background-alt-grey);
    }

    .search-results__item:focus-visible {
      outline: 2px solid var(--green-menthe-sun-373);
      outline-offset: -2px;
    }

    .search-results__name {
      font-weight: 400;
    }

    .search-results__arrow {
      display: flex;
      align-items: center;
      color: var(--text-mention-grey);
      flex-shrink: 0;
    }

    /* Section Catégories */
    .search-categories {
      padding-top: var(--spacing-2v);
    }

    .search-categories__title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-default);
      margin-bottom: var(--spacing-3v);
    }

    .search-categories__grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-3v);
      margin-bottom: var(--spacing-6v);
    }

    .category-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-4v) var(--spacing-2v) var(--spacing-3v);
      background-color: var(--green-menthe-975);
      border: 1px solid var(--green-menthe-sun-373);
      border-radius: var(--radius-md);
      cursor: pointer;
      text-align: center;
      transition: background-color 0.15s ease;
      min-height: 8rem;
    }

    .category-card:hover {
      background-color: #d0f9ef;
    }

    .category-card__icon {
      width: 3rem;
      height: 3rem;
      margin-bottom: var(--spacing-2v);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .category-card__icon img,
    .category-card__icon svg {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .category-card__name {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-default);
      line-height: 1.3;
      margin-bottom: var(--spacing-1v);
    }

    .category-card__count {
      font-size: 0.75rem;
      color: var(--text-mention-grey);
    }

    /* Section Populaires */
    .search-popular {
      padding-top: var(--spacing-2v);
    }

    .search-popular__title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-default);
      margin-bottom: var(--spacing-3v);
    }

    .search-popular__list {
      list-style: none;
    }

    .search-popular__item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-3v) 0;
      border-bottom: 1px solid var(--border-default);
      font-size: 0.9375rem;
      color: var(--text-default);
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .search-popular__item:focus-visible {
      outline: 2px solid var(--green-menthe-sun-373);
      outline-offset: -2px;
    }

    .search-popular__arrow {
      display: flex;
      align-items: center;
      color: var(--text-mention-grey);
      flex-shrink: 0;
    }

    .search-popular__item:hover {
      background-color: var(--background-alt-grey);
    }

    /* ============================================
       Section Données / Statistiques
       ============================================ */
    .stats-section {
      background-color: var(--green-menthe-975);
      padding: var(--spacing-4v) var(--spacing-4v) var(--spacing-4v);
    }

    .stats-intro {
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--green-menthe-sun-373);
      margin-bottom: var(--spacing-4v);
    }

    .stats-intro strong {
      font-weight: 700;
      color: var(--green-menthe-sun-373);
    }

    .stats-list {
      list-style: none;
    }

    .stats-list__item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-3v) 0;
      border-bottom: 1px solid var(--green-menthe-sun-373);
    }

    .stats-list__item:first-child {
      border-top: 1px solid var(--green-menthe-sun-373);
    }

    .stats-list__label {
      display: flex;
      align-items: center;
      gap: var(--spacing-2v);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--green-menthe-sun-373);
    }

    .stats-list__label-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.25rem;
      height: 1.25rem;
      color: var(--green-menthe-sun-373);
      flex-shrink: 0;
    }

    .stats-list__label-icon svg {
      width: 1.125rem;
      height: 1.125rem;
    }

    .stats-list__value {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--green-menthe-sun-373);
    }

    /* ============================================
       Section Accordéon
       ============================================ */
    .accordion-section {
      padding: var(--spacing-6v) var(--spacing-4v);
    }

    .accordion {
      border: none;
    }

    .accordion__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background-color: var(--background-action-low-blue);
      border: none;
      padding: var(--spacing-4v);
      cursor: pointer;
      text-align: left;
      font-family: 'Marianne', arial, sans-serif;
      border-radius: var(--radius-sm);
      transition: background-color 0.2s ease;
    }

    .accordion__header:hover {
      background-color: #EBEBFF;
    }

    .accordion__header:focus-visible {
      outline: 2px solid var(--border-active-blue);
      outline-offset: 2px;
    }

    .accordion__title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--blue-france);
      line-height: 1.4;
      padding-right: var(--spacing-4v);
    }

    .accordion__icon {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: var(--blue-france);
      transition: transform 0.3s ease;
    }

    .accordion__icon svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    .accordion[open] .accordion__icon {
      transform: rotate(180deg);
    }

    .accordion[open] .accordion__header {
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    }

    .accordion__content {
      padding: var(--spacing-4v);
      background-color: var(--background-default);
      border: 1px solid var(--border-default);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }

    .accordion__text {
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text-default);
      margin-bottom: var(--spacing-4v);
    }

    /* Bouton DSFR Secondary Small */
    .btn-secondary-sm {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-2v);
      padding: var(--spacing-1v) var(--spacing-3v);
      font-family: 'Marianne', arial, sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--blue-france);
      background-color: transparent;
      border: 1px solid var(--blue-france);
      border-radius: var(--radius-sm);
      cursor: pointer;
      text-decoration: none;
      line-height: 1.5;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    .btn-secondary-sm:hover {
      background-color: var(--background-action-low-blue);
    }

    .btn-secondary-sm:focus-visible {
      outline: 2px solid var(--border-active-blue);
      outline-offset: 2px;
    }

    .btn-secondary-sm:active {
      background-color: #DDDDFB;
    }

    .btn-secondary-sm__icon {
      display: flex;
      align-items: center;
    }

    .btn-secondary-sm__icon svg {
      width: 0.875rem;
      height: 0.875rem;
    }

    /* ============================================
       Footer
       ============================================ */
    .footer {
      padding: var(--spacing-6v) var(--spacing-4v);
      border-top: 1px solid var(--border-default);
    }

    .footer__description {
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text-default);
      margin-bottom: var(--spacing-4v);
    }

    .footer__link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-1v);
      color: var(--blue-france);
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      margin-bottom: var(--spacing-6v);
      width: 100%;
      text-align: center;
    }

    .footer__link:hover {
      text-decoration: underline;
    }

    .footer__link svg {
      width: 0.875rem;
      height: 0.875rem;
      flex-shrink: 0;
    }

    .footer__logos {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--spacing-6v);
    }

    .footer__logos img {
      height: 2.25rem;
      width: auto;
    }

    /* Boutons footer (Partager / Intégrer) */
    .footer__actions {
      display: flex;
      gap: var(--spacing-3v);
    }

    .btn-footer {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-2v);
      padding: var(--spacing-2v) var(--spacing-4v);
      font-family: 'Marianne', arial, sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      cursor: pointer;
      text-decoration: none;
      line-height: 1.5;
      transition: background-color 0.2s ease;
    }

    .btn-footer--share {
      color: var(--blue-france);
      background-color: transparent;
      border: 1px solid var(--blue-france);
    }

    .btn-footer--share:hover {
      background-color: var(--background-action-low-blue);
    }

    .btn-footer--embed {
      color: var(--text-inverted);
      background-color: var(--blue-france);
      border: 1px solid var(--blue-france);
    }

    .btn-footer--embed:hover {
      background-color: var(--blue-france-hover);
    }

    .btn-footer:focus-visible {
      outline: 2px solid var(--border-active-blue);
      outline-offset: 2px;
    }

    .btn-footer svg {
      width: 1rem;
      height: 1rem;
      flex-shrink: 0;
    }

    /* ============================================
       Responsive
       ============================================ */
    @media (min-width: 576px) {
      .search-section {
        padding: var(--spacing-8v) var(--spacing-6v) 0;
      }

      .search-panel {
        padding: 0 var(--spacing-6v) var(--spacing-6v);
      }

      .stats-section {
        padding: var(--spacing-6v) var(--spacing-6v) var(--spacing-6v);
      }

      .accordion-section {
        padding: var(--spacing-8v) var(--spacing-6v);
      }

      .footer {
        padding: var(--spacing-8v) var(--spacing-6v);
      }
    }

    @media (min-width: 768px) {
      .search-section {
        padding: var(--spacing-10v) var(--spacing-12v) 0;
      }

      .search-panel {
        padding: 0 var(--spacing-12v) var(--spacing-8v);
      }

      .stats-section {
        padding: var(--spacing-8v) var(--spacing-12v) var(--spacing-8v);
      }

      .accordion-section {
        padding: var(--spacing-10v) var(--spacing-12v);
      }

      .footer {
        padding: var(--spacing-10v) var(--spacing-12v);
      }

      .footer__actions {
        max-width: 28rem;
      }

      .search-categories__grid {
        grid-template-columns: 1fr 1fr 1fr 1fr;
      }
    }

    /* ============================================
       Étape 3 — Fiche résultat
       ============================================ */

    .fiche-section {
      display: none;
    }

    .iframe-container.step-fiche .search-section,
    .iframe-container.step-fiche .search-panel,
    .iframe-container.step-fiche .stats-section,
    .iframe-container.step-fiche .accordion-section,
    .iframe-container.step-fiche .territory-section {
      display: none;
    }

    .iframe-container.step-fiche .fiche-section {
      display: block;
    }

    .iframe-container.step-fiche .footer {
      display: block;
    }

    /* En-tête fiche */
    .fiche-header {
      background-color: var(--green-menthe-975);
      padding: var(--spacing-6v) var(--spacing-4v);
    }

    .fiche-header__searchbox {
      display: flex;
      flex-direction: column;
      background-color: var(--background-default);
      border: 2px solid var(--green-menthe-sun-373);
      border-radius: var(--radius-md);
      padding: var(--spacing-3v) var(--spacing-4v);
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-bottom: var(--spacing-3v);
      text-align: left;
      font-family: 'Marianne', arial, sans-serif;
      width: 100%;
    }

    .fiche-header__searchbox:hover {
      background-color: var(--background-alt-grey);
    }

    .fiche-header__searchbox:focus-visible {
      outline: 2px solid var(--green-menthe-sun-373);
      outline-offset: 2px;
    }

    .fiche-header__object-name {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-default);
      line-height: 1.5;
    }

    .fiche-header__object-address {
      font-size: 0.875rem;
      color: var(--text-mention-grey);
      margin-top: 2px;
    }

    .fiche-header__total {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--green-menthe-sun-373);
      line-height: 1.5;
    }

    /* Info-tri */
    .fiche-infotri {
      padding: var(--spacing-6v) var(--spacing-4v);
      background-color: var(--background-default);
    }

    .fiche-infotri__title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-default);
      margin-bottom: var(--spacing-4v);
    }

    .fiche-infotri__images {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-3v);
    }

    .fiche-infotri__img {
      width: 100%;
      max-width: 420px;
      height: auto;
    }

    /* Accordéons fiche — style DSFR */
    .fiche-accordeons {
      padding: var(--spacing-4v) var(--spacing-4v) var(--spacing-2v);
    }

    .fiche-accordion {
      border: none;
      border-bottom: 1px solid var(--border-default);
    }

    .fiche-accordion__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background-color: transparent;
      border: none;
      padding: var(--spacing-3v) 0;
      cursor: pointer;
      text-align: left;
      font-family: 'Marianne', arial, sans-serif;
    }

    .fiche-accordion__header:focus-visible {
      outline: 2px solid var(--border-active-blue);
      outline-offset: 2px;
    }

    .fiche-accordion__header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .fiche-accordion__title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--blue-france);
      line-height: 1.5;
    }

    .fiche-accordion__subtitle {
      font-size: 0.8125rem;
      color: var(--text-mention-grey);
      font-weight: 400;
    }

    .fiche-accordion__icon {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: var(--blue-france);
      transition: transform 0.3s ease;
    }

    .fiche-accordion__icon svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    .fiche-accordion[open] .fiche-accordion__icon {
      transform: rotate(180deg);
    }

    .fiche-accordion__content {
      padding: 0 0 var(--spacing-4v);
      background-color: var(--background-default);
    }

    .fiche-accordion__consigne {
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text-default);
    }

    .fiche-accordion__condition {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--blue-france);
      text-transform: uppercase;
      letter-spacing: 0.02em;
      margin-bottom: var(--spacing-2v);
    }

    /* Avertissements */
    .fiche-warnings {
      padding: 0 var(--spacing-4v) var(--spacing-4v);
    }

    .fiche-warnings__list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-2v);
    }

    .fiche-warnings__item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-2v);
      font-size: 0.8125rem;
      line-height: 1.5;
      color: var(--text-label-grey);
      background-color: #FEF3CD;
      border-radius: var(--radius-sm);
      padding: var(--spacing-3v);
    }

    .fiche-warnings__icon {
      flex-shrink: 0;
      width: 1rem;
      height: 1rem;
      color: #856404;
      margin-top: 1px;
    }

    /* Section carte */
    .fiche-map {
      padding: var(--spacing-4v);
    }

    .fiche-map__title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-default);
      margin-bottom: var(--spacing-4v);
    }

    .fiche-map__container {
      min-height: 400px;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .fiche-map__container iframe,
    .fiche-map__container > div {
      width: 100%;
      min-height: 400px;
    }

    /* Solutions cards */
    .fiche-solutions {
      padding: var(--spacing-4v);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-3v);
    }

    .fiche-solution-card {
      border: 1px solid var(--border-default);
      border-radius: var(--radius-sm);
      padding: var(--spacing-4v);
    }

    .fiche-solution-card__title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--blue-france);
      margin-bottom: var(--spacing-2v);
    }

    .fiche-solution-card__desc {
      font-size: 0.8125rem;
      line-height: 1.5;
      color: var(--text-mention-grey);
      margin-bottom: var(--spacing-3v);
    }

    .fiche-solution-card__link {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-2v);
      padding: var(--spacing-2v) var(--spacing-3v);
      font-family: 'Marianne', arial, sans-serif;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--blue-france);
      background-color: transparent;
      border: 1px solid var(--blue-france);
      border-radius: var(--radius-sm);
      cursor: pointer;
      text-decoration: none;
      line-height: 1.5;
      transition: background-color 0.2s ease;
    }

    .fiche-solution-card__link:hover {
      background-color: var(--background-action-low-blue);
    }

    .fiche-solution-card__link:focus-visible {
      outline: 2px solid var(--border-active-blue);
      outline-offset: 2px;
    }

    .fiche-solution-card__link svg {
      width: 0.875rem;
      height: 0.875rem;
      flex-shrink: 0;
    }

    /* Responsive fiche */
    @media (min-width: 576px) {
      .fiche-header {
        padding: var(--spacing-8v) var(--spacing-6v);
      }

      .fiche-infotri {
        padding: var(--spacing-6v) var(--spacing-6v);
      }

      .fiche-accordeons {
        padding: 0 var(--spacing-6v) var(--spacing-6v);
      }

      .fiche-warnings {
        padding: 0 var(--spacing-6v) var(--spacing-6v);
      }

      .fiche-map {
        padding: var(--spacing-6v);
      }

      .fiche-solutions {
        padding: var(--spacing-6v);
        flex-direction: row;
      }

      .fiche-solution-card {
        flex: 1;
      }
    }

    @media (min-width: 768px) {
      .fiche-header {
        padding: var(--spacing-10v) var(--spacing-12v);
      }

      .fiche-infotri {
        padding: var(--spacing-8v) var(--spacing-12v);
      }

      .fiche-accordeons {
        padding: 0 var(--spacing-12v) var(--spacing-8v);
      }

      .fiche-warnings {
        padding: 0 var(--spacing-12v) var(--spacing-8v);
      }

      .fiche-map {
        padding: var(--spacing-8v) var(--spacing-12v);
      }

      .fiche-solutions {
        padding: var(--spacing-8v) var(--spacing-12v);
      }
    }

    /* Bullet points dans les consignes */
    .fiche-accordion__consigne ul {
      list-style: disc;
      padding-left: var(--spacing-5v);
      margin: var(--spacing-2v) 0;
    }

    .fiche-accordion__consigne ul li {
      margin-bottom: var(--spacing-1v);
    }

    .fiche-accordion__consigne ul li:last-child {
      margin-bottom: 0;
    }

    .fiche-accordion__consigne p {
      margin: 0 0 var(--spacing-2v);
    }

    .fiche-accordion__consigne p:last-child {
      margin-bottom: 0;
    }

    .fiche-accordion__consigne a {
      color: var(--blue-france);
      text-decoration: underline;
    }

    .fiche-accordion__consigne a:hover {
      text-decoration: none;
    }

    /* Card DSFR callout (alertes structurées) */
    .fiche-card-alert {
      margin: 0 var(--spacing-4v) var(--spacing-4v);
      padding: var(--spacing-4v);
      background-color: var(--background-alt-grey);
      border-left: 4px solid var(--red-marianne);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }

    .fiche-card-alert__title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-default);
      margin-bottom: var(--spacing-2v);
    }

    .fiche-card-alert__content {
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text-default);
    }

    .fiche-card-alert__content ul {
      list-style: disc;
      padding-left: var(--spacing-5v);
      margin: var(--spacing-2v) 0;
    }

    .fiche-card-alert__content ul li {
      margin-bottom: var(--spacing-1v);
    }

    .fiche-card-alert__content ul li:last-child {
      margin-bottom: 0;
    }

    /* Section affichage direct (sans accordéon) */
    .fiche-direct-section {
      padding: var(--spacing-3v) 0;
      border-bottom: 1px solid var(--border-default);
    }

    .fiche-direct-section .fiche-accordion__title {
      display: block;
      margin-bottom: 2px;
    }

    .fiche-direct-section .fiche-accordion__subtitle {
      display: block;
      margin-bottom: var(--spacing-3v);
    }

    .fiche-direct-section .fiche-accordion__consigne {
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text-default);
    }

    /* Info-tri taille réduite */
    .fiche-infotri__img--small {
      max-width: 280px;
    }

    @media (min-width: 576px) {
      .fiche-card-alert {
        margin: 0 var(--spacing-6v) var(--spacing-6v);
      }
    }

    @media (min-width: 768px) {
      .fiche-card-alert {
        margin: 0 var(--spacing-12v) var(--spacing-8v);
      }
    }

    /* ============================================
       Utilitaires
       ============================================ */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Quand le panneau de recherche est ouvert */
    .iframe-container.search-active .search-section {
      background-color: var(--background-default);
    }

    .iframe-container.search-active .stats-section,
    .iframe-container.search-active .accordion-section,
    .iframe-container.search-active .footer {
      display: none;
    }

    /* ============================================
       Étape 2 — Section Territoire
       ============================================ */

    /* Visibilité par étape */
    .territory-section {
      display: none;
    }

    .iframe-container.step-territory .search-section,
    .iframe-container.step-territory .search-panel,
    .iframe-container.step-territory .stats-section,
    .iframe-container.step-territory .accordion-section {
      display: none;
    }

    .iframe-container.step-territory .territory-section {
      display: block;
    }

    /* Header territoire (fond vert menthe) */
    .territory-section__header {
      background-color: var(--green-menthe-975);
      padding: var(--spacing-6v) var(--spacing-4v) 0;
    }

    /* Bouton retour DSFR secondary */
    .selected-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-2v);
      padding: var(--spacing-2v) var(--spacing-4v) var(--spacing-2v) var(--spacing-3v);
      background-color: var(--background-default);
      border: 1px solid var(--blue-france);
      border-radius: var(--radius-sm);
      color: var(--blue-france);
      font-family: 'Marianne', arial, sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      line-height: 1.5;
    }

    .selected-chip:hover {
      background-color: var(--background-action-low-blue);
    }

    .selected-chip:active {
      background-color: #DDDDFB;
    }

    .selected-chip:focus-visible {
      outline: 2px solid var(--blue-france);
      outline-offset: 2px;
    }

    .selected-chip__icon {
      display: flex;
      align-items: center;
      flex-shrink: 0;
      color: var(--blue-france);
    }

    .selected-chip__icon svg {
      width: 0.875rem;
      height: 0.875rem;
    }

    /* Recherche adresse */
    .territory-search {
      background-color: var(--green-menthe-975);
      padding: var(--spacing-4v) var(--spacing-4v) var(--spacing-6v);
      position: relative;
    }

    .territory-search__title {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.5;
      color: var(--text-default);
      margin-bottom: var(--spacing-4v);
    }

    /* Dropdown autocomplétion adresse */
    .address-results {
      display: none;
      list-style: none;
      background-color: var(--background-default);
      border: 2px solid var(--green-menthe-sun-373);
      border-top: 1px solid var(--border-default);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 15rem;
      overflow-y: auto;
      margin-top: -2px;
      position: relative;
      z-index: 10;
    }

    .address-results.is-visible {
      display: block;
    }

    .address-results__item {
      padding: var(--spacing-3v) var(--spacing-4v);
      font-size: 0.875rem;
      color: var(--text-default);
      cursor: pointer;
      border-bottom: 1px solid var(--border-default);
      transition: background-color 0.1s ease;
    }

    .address-results__item:last-child {
      border-bottom: none;
    }

    .address-results__item:hover,
    .address-results__item.is-focused {
      background-color: var(--background-alt-grey);
    }

    /* Stats territoire (dynamique) */
    .stats-section--territory {
      background-color: var(--green-menthe-975);
      padding: 0 var(--spacing-4v) var(--spacing-4v);
    }

    .stats-section--territory .stats-intro {
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--green-menthe-sun-373);
      margin-bottom: var(--spacing-4v);
    }

    .stats-section--territory .stats-intro strong {
      font-weight: 700;
    }

    /* Responsive territoire */
    @media (min-width: 576px) {
      .territory-section__header {
        padding: var(--spacing-8v) var(--spacing-6v) 0;
      }

      .territory-search {
        padding: var(--spacing-4v) var(--spacing-6v) var(--spacing-6v);
      }

      .stats-section--territory {
        padding: 0 var(--spacing-6v) var(--spacing-6v);
      }
    }

    @media (min-width: 768px) {
      .territory-section__header {
        padding: var(--spacing-10v) var(--spacing-12v) 0;
      }

      .territory-search {
        padding: var(--spacing-4v) var(--spacing-12v) var(--spacing-8v);
      }

      .stats-section--territory {
        padding: 0 var(--spacing-12v) var(--spacing-8v);
      }
    }
  </style>
</head>
<body>
  <div class="iframe-container" role="main">

    <!-- =============================================
         Section Recherche
         ============================================= -->
    <section class="search-section" aria-labelledby="search-title">
      <button class="search-section__close" id="search-panel-close" type="button" aria-label="Fermer la recherche">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      <h1 class="search-section__title" id="search-title">
        Pour quel objet ou déchet recherchez-vous des recommandations et des solutions&nbsp;?
      </h1>

      <div class="search-bar" role="search">
        <div class="search-bar__icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
        </div>
        <label for="search-input" class="sr-only">Rechercher un objet ou un déchet</label>
        <input
          type="search"
          id="search-input"
          class="search-bar__input"
          placeholder="exemple : vis, téléphone, CD-ROM..."
          autocomplete="off"
        >
      </div>
    </section>

    <!-- =============================================
         Panneau de recherche (s'ouvre au clic)
         ============================================= -->
    <div class="search-panel" id="search-panel">
      <p class="search-panel__hint">
        Une fois votre recherche effectuée, sélectionnez un résultat dans la liste pour passer à l'étape suivante.
      </p>

      <!-- Résultats de recherche dynamiques -->
      <ul class="search-results" id="search-results" aria-label="Résultats de recherche"></ul>

      <!-- Par catégorie -->
      <div class="search-categories" id="search-categories">
        <h2 class="search-categories__title">Par catégorie</h2>
        <div class="search-categories__grid">

          <!-- Petit électroménager -->
          <div class="category-card" data-category="petit-electromenager">
            <div class="category-card__icon">
              <img src="src/assets/bouilloire.svg" alt="" aria-hidden="true">
            </div>
            <span class="category-card__name">Petits électroménagers</span>
            <span class="category-card__count">347 solutions</span>
          </div>

          <!-- Médicaments -->
          <div class="category-card" data-category="medicaments">
            <div class="category-card__icon">
              <img src="src/assets/medicaments.svg" alt="" aria-hidden="true">
            </div>
            <span class="category-card__name">Médicaments</span>
            <span class="category-card__count">8 392 solutions</span>
          </div>

          <!-- Meubles -->
          <div class="category-card" data-category="meubles">
            <div class="category-card__icon">
              <img src="src/assets/canapetextile.svg" alt="" aria-hidden="true">
            </div>
            <span class="category-card__name">Meubles</span>
            <span class="category-card__count">28 293 solutions</span>
          </div>

          <!-- Déchets alimentaires -->
          <div class="category-card" data-category="dechets-alimentaires">
            <div class="category-card__icon">
              <img src="src/assets/poireau.svg" alt="" aria-hidden="true">
            </div>
            <span class="category-card__name">Déchets alimentaires</span>
            <span class="category-card__count">183 829 solutions</span>
          </div>

        </div>
      </div>

      <!-- Les plus populaires -->
      <div class="search-popular" id="search-popular">
        <h2 class="search-popular__title">Les plus populaires</h2>
        <ul class="search-popular__list">
          <li class="search-popular__item" data-fiche-id="cd-dvd-vhs" role="button" tabindex="0">
            <span>CD, DVD ou cassettes VHS</span>
            <span class="search-popular__arrow" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg></span>
          </li>
          <li class="search-popular__item" data-fiche-id="chaussures" role="button" tabindex="0">
            <span>Chaussures</span>
            <span class="search-popular__arrow" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg></span>
          </li>
          <li class="search-popular__item" data-fiche-id="marteau" role="button" tabindex="0">
            <span>Marteau</span>
            <span class="search-popular__arrow" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg></span>
          </li>
          <li class="search-popular__item" data-fiche-id="aiguille-medicale" role="button" tabindex="0">
            <span>Seringue avec aiguille</span>
            <span class="search-popular__arrow" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg></span>
          </li>
          <li class="search-popular__item" data-fiche-id="trottinette-electrique" role="button" tabindex="0">
            <span>Trottinette électrique</span>
            <span class="search-popular__arrow" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg></span>
          </li>
          <li class="search-popular__item" data-fiche-id="brique-alimentaire" role="button" tabindex="0">
            <span>Brique alimentaire (jus, lait…)</span>
            <span class="search-popular__arrow" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg></span>
          </li>
        </ul>
      </div>
    </div>

    <!-- =============================================
         Section Territoire (Étape 2)
         ============================================= -->
    <section class="territory-section" id="territory-section">

      <!-- Chip objet sélectionné -->
      <div class="territory-section__header">
        <button class="selected-chip" id="selected-chip" type="button" aria-label="Modifier la recherche">
          <span class="selected-chip__icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </span>
          <span id="selected-chip-label"></span>
        </button>
      </div>

      <!-- Recherche d'adresse -->
      <div class="territory-search">
        <h2 class="territory-search__title" id="territory-title">
          Sur quel territoire souhaitez-vous consulter les informations pour cet objet ou ce déchet&nbsp;?
        </h2>
        <div class="search-bar" role="search">
          <div class="search-bar__icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
          </div>
          <label for="address-input" class="sr-only">Rechercher une adresse ou une commune</label>
          <input
            type="search"
            id="address-input"
            class="search-bar__input"
            placeholder="exemple : Marseille, La Rochelle..."
            autocomplete="off"
          >
        </div>
        <!-- Résultats autocomplétion -->
        <ul class="address-results" id="address-results" role="listbox" aria-label="Suggestions d'adresses"></ul>
      </div>

      <!-- Statistiques dynamiques -->
      <div class="stats-section--territory" id="territory-stats" aria-live="polite">
        <p class="stats-intro" id="territory-stats-intro"></p>
        <ul class="stats-list" aria-label="Répartition des solutions">
          <li class="stats-list__item">
            <span class="stats-list__label">
              <span class="stats-list__label-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
              </span>
              Lieux
            </span>
            <span class="stats-list__value" id="stat-lieux">--</span>
          </li>
          <li class="stats-list__item">
            <span class="stats-list__label">
              <span class="stats-list__label-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
              </span>
              Services à domicile
            </span>
            <span class="stats-list__value" id="stat-services">--</span>
          </li>
          <li class="stats-list__item">
            <span class="stats-list__label">
              <span class="stats-list__label-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="2" y1="12" x2="22" y2="12"/>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
              </span>
              Solutions en ligne
            </span>
            <span class="stats-list__value" id="stat-en-ligne">--</span>
          </li>
        </ul>
      </div>

    </section>

    <!-- =============================================
         Section Statistiques
         ============================================= -->
    <section class="stats-section" aria-labelledby="stats-intro">
      <p class="stats-intro" id="stats-intro">
        <strong>353&nbsp;811 solutions</strong> partout en France pour prolonger la vie de vos objets, faire des économies et réduire vos déchets.
      </p>

      <ul class="stats-list" aria-label="Répartition des solutions">
        <li class="stats-list__item">
          <span class="stats-list__label">
            <span class="stats-list__label-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
            </span>
            Lieux
          </span>
          <span class="stats-list__value">352&nbsp;500</span>
        </li>
        <li class="stats-list__item">
          <span class="stats-list__label">
            <span class="stats-list__label-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </span>
            Services à domicile
          </span>
          <span class="stats-list__value">900</span>
        </li>
        <li class="stats-list__item">
          <span class="stats-list__label">
            <span class="stats-list__label-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
              </svg>
            </span>
            Solutions en ligne
          </span>
          <span class="stats-list__value">411</span>
        </li>
      </ul>
    </section>

    <!-- =============================================
         Section Accordéon
         ============================================= -->
    <section class="accordion-section">
      <details class="accordion">
        <summary class="accordion__header" aria-expanded="false">
          <span class="accordion__title">Je cherche à acheter, louer ou emprunter un objet</span>
          <span class="accordion__icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </summary>
        <div class="accordion__content">
          <p class="accordion__text">
            Vous êtes à la recherche d'un lieu près de chez vous ou d'un site Internet où acheter, louer ou emprunter un objet&nbsp;? Trouvez sur notre site Internet de nombreuses solutions.
          </p>
          <a
            href="https://quefairedemesdechets.ademe.fr/nos-outils/la-carte-nationale-de-la-consommation-responsable/"
            class="btn-secondary-sm"
            target="_blank"
            rel="noopener noreferrer"
          >
            Acheter, louer ou emprunter
            <span class="btn-secondary-sm__icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </svg>
            </span>
          </a>
        </div>
      </details>
    </section>

    <!-- =============================================
         Section Fiche (Étape 3)
         ============================================= -->
    <section class="fiche-section" id="fiche-section">

      <!-- En-tête -->
      <div class="fiche-header">
        <button class="fiche-header__searchbox" id="fiche-back-chip" type="button" aria-label="Modifier la recherche">
          <div class="fiche-header__object-name" id="fiche-object-name"></div>
          <div class="fiche-header__object-address" id="fiche-object-address"></div>
        </button>

        <p class="fiche-header__total" id="fiche-total-solutions"></p>
      </div>

      <!-- Info-tri -->
      <div class="fiche-infotri" id="fiche-infotri">
        <h2 class="fiche-infotri__title">Recommandations &amp; consignes</h2>
        <div class="fiche-infotri__images" id="fiche-infotri-images"></div>
      </div>

      <!-- Accordéons consignes -->
      <div class="fiche-accordeons" id="fiche-accordeons">
      </div>

      <!-- Avertissements -->
      <div class="fiche-warnings" id="fiche-warnings" style="display: none;">
        <ul class="fiche-warnings__list" id="fiche-warnings-list"></ul>
      </div>

      <!-- Carte des solutions -->
      <div class="fiche-map">
        <h2 class="fiche-map__title">Les solutions existantes</h2>
        <div class="fiche-map__container" id="fiche-map-container"></div>
      </div>

      <!-- Solutions à domicile & en ligne -->
      <div class="fiche-solutions">
        <div class="fiche-solution-card">
          <h3 class="fiche-solution-card__title">Les services à domicile</h3>
          <p class="fiche-solution-card__desc" id="fiche-sol-domicile-desc"></p>
          <a class="fiche-solution-card__link" id="fiche-sol-domicile-link" href="#" target="_blank" rel="noopener noreferrer">
            Je découvre les solutions
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
          </a>
        </div>
        <div class="fiche-solution-card">
          <h3 class="fiche-solution-card__title">Les solutions en ligne</h3>
          <p class="fiche-solution-card__desc" id="fiche-sol-enligne-desc"></p>
          <a class="fiche-solution-card__link" id="fiche-sol-enligne-link" href="#" target="_blank" rel="noopener noreferrer">
            Je découvre les sites Internet
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
          </a>
        </div>
      </div>

    </section>

    <!-- =============================================
         Footer
         ============================================= -->
    <footer class="footer">
      <p class="footer__description">
        Que faire de mes objets et déchets est un outil numérique public qui vous aide à prolonger la vie de vos objets, pour faire des économies et réduire vos déchets. Rejoignez nos 1,5&nbsp;millions d'usagers annuels&nbsp;!
      </p>

      <a
        href="https://www.quefairedemesdechets.ademe.fr"
        class="footer__link"
        target="_blank"
        rel="noopener noreferrer"
      >
        En savoir plus
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
          <polyline points="15 3 21 3 21 9"/>
          <line x1="10" y1="14" x2="21" y2="3"/>
        </svg>
      </a>

      <div class="footer__logos">
        <img src="src/assets/logos.svg" alt="République Française — ADEME — Que faire de mes objets et déchets ?">
      </div>

    </footer>

  </div>

  <script>
    // =============================================
    // Data Store — Fiches objets/déchets
    // =============================================
    const fichesData = [
      {
        id: 'petit-electromenager',
        nom: 'Petit électroménager',
        categorie: 'petit-electromenager',
        keywords: ['bouilloire', 'grille-pain', 'cafetière', 'machine à café', 'mixeur', 'blender', 'fer à repasser', 'aspirateur', 'robot culinaire', 'sèche-cheveux', 'rasoir électrique', 'balance de cuisine', 'petit électroménager', 'petit electromenager', 'toaster', 'friteuse']
      },
      {
        id: 'medicaments',
        nom: 'Médicaments',
        categorie: 'medicaments',
        keywords: ['médicament', 'medicament', 'médicaments', 'medicaments', 'comprimé', 'gélule', 'sirop', 'pilule', 'pommade', 'pharmacie']
      },
      {
        id: 'meubles',
        nom: 'Meubles',
        categorie: 'meubles',
        keywords: ['meuble', 'meubles', 'chaise', 'table', 'armoire', 'étagère', 'etagere', 'bureau', 'commode', 'canapé', 'canape', 'lit', 'bibliothèque', 'bibliotheque', 'buffet', 'fauteuil', 'tabouret']
      },
      {
        id: 'dechets-alimentaires',
        nom: 'Déchets alimentaires',
        categorie: 'dechets-alimentaires',
        keywords: ['déchet alimentaire', 'déchets alimentaires', 'biodéchet', 'compost', 'épluchure', 'épluchures', 'reste de repas', 'restes de repas', 'banane', 'fruit', 'légume', 'legume', 'marc de café', 'alimentaire', 'nourriture']
      },
      {
        id: 'cd-dvd-vhs',
        nom: 'CD, DVD ou cassettes VHS',
        categorie: 'cd-dvd-vhs',
        keywords: ['cd', 'dvd', 'cassette', 'cassettes', 'vhs', 'cd-rom', 'disque', 'disquette', 'vinyle']
      },
      {
        id: 'chaussures',
        nom: 'Chaussures',
        categorie: 'chaussures',
        keywords: ['chaussure', 'chaussures', 'basket', 'baskets', 'botte', 'bottes', 'sandale', 'sandales', 'talon', 'talons', 'mocassin']
      },
      {
        id: 'marteau',
        nom: 'Marteau',
        categorie: 'marteau',
        keywords: ['marteau', 'outil', 'outils', 'bricolage']
      },
      {
        id: 'aiguille-medicale',
        nom: 'Seringue avec aiguille',
        categorie: 'aiguille-medicale',
        keywords: ['aiguille', 'seringue', 'aiguille médicale', 'aiguille medicale', 'dasri', 'piquant', 'injection']
      },
      {
        id: 'trottinette-electrique',
        nom: 'Trottinette électrique',
        categorie: 'trottinette-electrique',
        keywords: ['trottinette', 'trottinette électrique', 'trottinette electrique', 'mobilité électrique']
      },
      {
        id: 'vetements',
        nom: 'Vêtements',
        categorie: 'vetements',
        keywords: ['vêtement', 'vetement', 'vêtements', 'vetements', 't-shirt', 'tshirt', 'pantalon', 'jupe', 'robe', 'pull', 'manteau', 'blouson', 'chemise', 'veste', 'short', 'jean', 'textile']
      },
      {
        id: 'livres',
        nom: 'Livres',
        categorie: 'livres',
        keywords: ['livre', 'livres', 'bouquin', 'roman', 'magazine', 'revue', 'bande dessinée', 'bd', 'manga']
      },
      {
        id: 'poeles-casseroles',
        nom: 'Poêles et casseroles',
        categorie: 'poeles-casseroles',
        keywords: ['poêle', 'poele', 'casserole', 'casseroles', 'poêles', 'poeles', 'ustensile de cuisine', 'fait-tout', 'cocotte', 'wok']
      },
      {
        id: 'sapin-de-noel',
        nom: 'Sapin de Noël',
        categorie: 'sapin-de-noel',
        keywords: ['sapin', 'sapin de noël', 'sapin de noel', 'sapin artificiel', 'sapin naturel', 'arbre de noël']
      },
      {
        id: 'brique-alimentaire',
        nom: 'Brique alimentaire (jus, lait…)',
        categorie: 'brique-alimentaire',
        keywords: ['brique alimentaire', 'brique', 'tetra pak', 'brique de lait', 'brique de jus', 'emballage alimentaire']
      },
      {
        id: 'gros-electromenager',
        nom: 'Gros électroménager',
        categorie: 'gros-electromenager',
        keywords: ['machine à laver', 'machine a laver', 'lave-linge', 'lave linge', 'lave-vaisselle', 'lave vaisselle', 'réfrigérateur', 'refrigerateur', 'frigo', 'four', 'congélateur', 'congelateur', 'sèche-linge', 'seche linge', 'gros électroménager', 'gros electromenager', 'plaque de cuisson', 'hotte', 'chauffe-eau']
      }
    ];

    // =============================================
    // State Management
    // =============================================
    const appState = {
      currentStep: 'search',     // 'search' | 'territory' | 'fiche'
      selectedFiche: null,       // { id, nom, categorie, keywords }
      selectedAddress: null,     // { label, citycode, postcode, lat, lon }
      categoryCounts: null,      // données chargées depuis counts.json
      consignesData: null,       // données chargées depuis consignes.json
      searchOrigin: 'home'       // 'home' | 'territory' — d'où vient l'ouverture de la recherche
    };

    // =============================================
    // Références DOM
    // =============================================
    const searchInput = document.getElementById('search-input');
    const searchPanel = document.getElementById('search-panel');
    const searchResults = document.getElementById('search-results');
    const searchCategories = document.getElementById('search-categories');
    const searchPopular = document.getElementById('search-popular');
    const container = document.querySelector('.iframe-container');

    // Étape 2
    const addressInput = document.getElementById('address-input');
    const addressResults = document.getElementById('address-results');
    const selectedChip = document.getElementById('selected-chip');
    const selectedChipLabel = document.getElementById('selected-chip-label');

    // =============================================
    // Utilitaires
    // =============================================
    function normalize(str) {
      return str.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s-]/g, '')
        .trim();
    }

    function formatNumber(n) {
      return n.toLocaleString('fr-FR');
    }

    // =============================================
    // Chargement des comptages
    // =============================================
    // =============================================
    // Données inlinées (pas de fetch, fonctionne en file://)
    // =============================================
    appState.categoryCounts = {
      national: {
        'petit-electromenager': { lieux: 24161, services_a_domicile: 72, solutions_en_ligne: 26 },
        'medicaments': { lieux: 20187, services_a_domicile: 60, solutions_en_ligne: 22 },
        'meubles': { lieux: 21201, services_a_domicile: 63, solutions_en_ligne: 23 },
        'dechets-alimentaires': { lieux: 30404, services_a_domicile: 91, solutions_en_ligne: 32 },
        'cd-dvd-vhs': { lieux: 18142, services_a_domicile: 54, solutions_en_ligne: 20 },
        'chaussures': { lieux: 51614, services_a_domicile: 154, solutions_en_ligne: 53 },
        'marteau': { lieux: 14649, services_a_domicile: 43, solutions_en_ligne: 16 },
        'aiguille-medicale': { lieux: 20188, services_a_domicile: 60, solutions_en_ligne: 22 },
        'trottinette-electrique': { lieux: 14004, services_a_domicile: 42, solutions_en_ligne: 16 },
        'vetements': { lieux: 59796, services_a_domicile: 179, solutions_en_ligne: 61 },
        'livres': { lieux: 18590, services_a_domicile: 55, solutions_en_ligne: 20 },
        'poeles-casseroles': { lieux: 7256, services_a_domicile: 21, solutions_en_ligne: 9 },
        'sapin-de-noel': { lieux: 34074, services_a_domicile: 102, solutions_en_ligne: 36 },
        'brique-alimentaire': { lieux: 47201, services_a_domicile: 141, solutions_en_ligne: 49 },
        'gros-electromenager': { lieux: 15873, services_a_domicile: 47, solutions_en_ligne: 17 }
      }
    };

    appState.consignesData = {
      fiches: [
        {
          id: 'petit-electromenager',
          nom: 'Petit électroménager',
          url: 'https://quefairedemesdechets.ademe.fr/categories/petit-electromenager/',
          infoTri: 'petit-electromenager.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/tous-les-gestes/?action_displayed=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=88',
          accordeons: [
            { titre: 'Réparer', icone: 'reparer', consigne: '<ul><li>Faites réparer votre appareil chez un réparateur agréé.</li><li><a href="https://quefairedemesdechets.ademe.fr/bonus-reparation/" target="_blank" rel="noopener noreferrer">Bonus Réparation</a>\u00a0: jusqu\u2019à 40\u00a0\u20ac de réduction sur la facture.</li></ul>', condition: 'Réparable' },
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Donnez gratuitement à une structure de réemploi (recyclerie, ressourcerie, association).</li><li>Revendez via un dépôt-vente ou une plateforme de seconde main.</li></ul>', condition: 'En bon état' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Déposez dans un bac de collecte en magasin.</li><li>Apportez en déchèterie, dans la benne dédiée aux DEEE.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'medicaments',
          nom: 'Médicaments',
          url: 'https://quefairedemesdechets.ademe.fr/categories/medicaments/',
          infoTri: 'medicaments.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/ass-deposer-uniquement/?sc_id=198',
          accordeons: [
            { titre: 'Rapporter en pharmacie', icone: 'deposer', consigne: '<ul><li>Rapportez les médicaments périmés, entamés ou inutilisés en pharmacie, sans leur boîte ni notice.</li><li>Apportez\u00a0: comprimés, gélules, sirops, pilules, pommades, sprays, aérosols, ampoules pleines…</li><li>Retirez les boîtes en carton, notices, blisters et plaquettes vides\u00a0: déposez-les dans le bac de tri des emballages.</li><li>Flacons, bouteilles et ampoules en verre vides\u00a0: déposez-les dans le conteneur à verre (sans les bouchons, à jeter dans le bac des emballages).</li></ul>', condition: null }
          ],
          cardAlert: '<ul><li>Ne jetez pas les médicaments à la poubelle ou dans les toilettes\u00a0: les principes actifs polluent l\u2019eau et les sols.</li><li>Ne donnez pas vos médicaments à des proches ou associations\u00a0: c\u2019est interdit en France (article R.5125-48 du Code de la santé publique).</li><li>Ne rapportez pas les compléments alimentaires ou cosmétiques en pharmacie\u00a0: ils vont dans la poubelle des ordures ménagères, leurs emballages se trient séparément.</li></ul>'
        },
        {
          id: 'meubles',
          nom: 'Meubles',
          url: 'https://quefairedemesdechets.ademe.fr/categories/meubles/',
          infoTri: 'meubles.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/carte-assistant-sauf-pret-et-location/?action_displayed=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=100',
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Donnez à une recyclerie, ressourcerie ou association (certaines récupèrent à domicile).</li><li>Revendez via un dépôt-vente ou une plateforme de seconde main.</li></ul>', condition: 'En bon état' },
            { titre: 'Réparer', icone: 'reparer', consigne: '<ul><li>Faites réparer ou relooker votre meuble chez un professionnel.</li><li><a href="https://quefairedemesdechets.ademe.fr/bonus-reparation/" target="_blank" rel="noopener noreferrer">Bonus Réparation</a>\u00a0: jusqu\u2019à 65\u00a0\u20ac de la facture.</li></ul>', condition: 'Réparable' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Demandez la reprise en magasin lors d\u2019un nouvel achat.</li><li>Déposez dans un point de collecte ou en déchèterie.</li><li>Le service des encombrants peut aussi être disponible dans votre commune.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'dechets-alimentaires',
          nom: 'Déchets alimentaires',
          url: 'https://quefairedemesdechets.ademe.fr/categories/biodechets/dechets-alimentaires/',
          infoTri: 'dechets-alimentaires.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/ass-deposer-uniquement/?sc_id=267',
          accordeons: [
            { titre: 'Composter', icone: 'deposer', consigne: '<p>Les déchets alimentaires (épluchures, fanes, restes de repas, produits périmés sans emballage…) font partie des biodéchets et sont naturellement biodégradables.</p><p><strong>À mettre au compost</strong></p><ul><li>Épluchures, fanes, fruits et légumes abîmés.</li><li>Restes de repas, produits périmés, pain, laitages, croûtes de fromage.</li><li>Marc de café, filtres en papier, contenus des sachets de thé et tisanes.</li></ul><p>💡 Peaux dures (agrumes, melon…)\u00a0: coupez-les en morceaux.</p><p><strong>En petites quantités</strong></p><ul><li>Os et restes de viande.</li><li>Arêtes et peaux de poisson, fruits de mer.</li><li>Coquillages et coquilles d\u2019œuf.</li><li>Coques et noyaux de fruits.</li></ul><p>💡 Broyez-les pour faciliter le compostage.</p><p><strong>À ne pas composter</strong></p><ul><li>Huiles alimentaires usagées (ne les versez pas dans l\u2019évier).</li><li>Déchets non alimentaires (verre, métaux, plastiques, tissus, couches-culottes…).</li><li>Lombricomposteur\u00a0: certains aliments sont déconseillés (agrumes, ail…).</li></ul>', condition: null }
          ]
        },
        {
          id: 'cd-dvd-vhs',
          nom: 'CD, DVD ou cassettes VHS',
          url: 'https://quefairedemesdechets.ademe.fr/categories/cd-dvd-cassettes-vhs/',
          infoTri: 'cd-dvd-vhs.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/tous-les-gestes/?action_displayed=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=95&sc_id=270',
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Donnez à une association, bibliothèque, médiathèque ou structure de réemploi.</li><li>Revendez auprès d\u2019un disquaire, d\u2019un commerce d\u2019achat-vente ou sur un site de seconde main.</li></ul>', condition: 'En bon état' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Apportez en déchèterie si vous en avez beaucoup.</li><li>Sinon, jetez dans la poubelle des ordures ménagères.</li></ul>', condition: 'Hors d\u2019usage' }
          ],
          avertissements: [
            'Les boîtiers en plastique n\u2019ont pas de filière de recyclage nationale et doivent être jetés avec les ordures ménagères ou déposés en déchèterie. Séparez les pochettes en papier\u00a0: elles peuvent être jetées dans le bac de tri des emballages et papiers.'
          ]
        },
        {
          id: 'chaussures',
          nom: 'Chaussures',
          url: 'https://quefairedemesdechets.ademe.fr/dechet/chaussures/',
          infoTri: 'chaussures.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/tous-les-gestes/?action_displayed=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=109',
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Proposez-les à un proche, déposez en boutique de seconde main ou association.</li><li>Déposez dans un conteneur à textiles, dans un sac fermé.</li></ul>', condition: 'En bon état' },
            { titre: 'Réparer', icone: 'reparer', consigne: '<ul><li>Faites réparer chez un cordonnier.</li><li><a href="https://quefairedemesdechets.ademe.fr/bonus-reparation/" target="_blank" rel="noopener noreferrer">Bonus Réparation</a> peut s\u2019appliquer pour prolonger leur durée de vie.</li></ul>', condition: 'Réparable' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Déposez dans un conteneur à textiles ou en déchèterie, dans un sac fermé.</li><li>Assemblez toujours les chaussures par paires pour simplifier le tri.</li><li>Même abîmées, elles seront recyclées.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'marteau',
          nom: 'Marteau',
          url: 'https://quefairedemesdechets.ademe.fr/dechet/marteau/',
          infoTri: 'marteau.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/tous-les-gestes/?action_displayed=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=98',
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Proposez à un proche, donnez à une association ou une structure de réemploi.</li><li>Vous pouvez aussi essayer de le revendre.</li></ul>', condition: 'En bon état' },
            { titre: 'Réparer', icone: 'reparer', consigne: '<ul><li>Faites réparer votre outil chez un professionnel.</li></ul>', condition: 'Réparable' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Apportez en magasin (bac de collecte) ou en déchèterie.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'aiguille-medicale',
          nom: 'Seringue avec aiguille',
          url: 'https://quefairedemesdechets.ademe.fr/dechet/seringue-avec-aiguille/',
          infoTri: 'aiguille-medicale.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/product/?sc_id=281',
          directDisplay: true,
          accordeons: [
            { titre: 'Déposer en pharmacie', icone: 'deposer', consigne: '<ul><li>Placez vos seringues et aiguilles usagées dans la boîte jaune à couvercle vert (boîte DASRI), disponible gratuitement en pharmacie.</li><li>Une fois pleine, rapportez-la en pharmacie pour collecte sécurisée.</li><li>Les déchets sont incinérés avec valorisation énergétique.</li><li>Ne jetez jamais de seringues ou d\u2019aiguilles à la poubelle ni dans le bac de tri.</li></ul>', condition: null }
          ]
        },
        {
          id: 'trottinette-electrique',
          nom: 'Trottinette électrique',
          url: 'https://quefairedemesdechets.ademe.fr/dechet/trottinette-electrique/',
          infoTri: 'trottinette-electrique.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/tous-les-gestes/?action_displayed=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=264',
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Proposez à un proche, donnez à une association ou une structure de réemploi.</li><li>Revendez d\u2019occasion.</li></ul>', condition: 'En bon état' },
            { titre: 'Réparer', icone: 'reparer', consigne: '<ul><li>Faites réparer grâce au <a href="https://quefairedemesdechets.ademe.fr/bonus-reparation/" target="_blank" rel="noopener noreferrer">Bonus Réparation</a> pour prolonger sa durée de vie et économiser.</li></ul>', condition: 'Réparable' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Apportez en magasin (bac de collecte ou remise au vendeur) ou en déchèterie.</li><li>Elle sera démontée, dépolluée et ses matériaux recyclés (filière DEEE).</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'vetements',
          nom: 'Vêtements',
          url: 'https://quefairedemesdechets.ademe.fr/categories/vetements/',
          infoTri: 'vetements.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/carte-assistant-sauf-pret-et-location/?action_displayed=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=107',
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Remettez à une association, recyclerie ou structure de réemploi.</li><li>Vendez en boutique ou sur une plateforme de seconde main.</li><li>Déposez dans un point de collecte textile.</li><li>Les textiles doivent être propres, secs et dans un sac fermé.</li></ul>', condition: 'En bon état' },
            { titre: 'Réparer', icone: 'reparer', consigne: '<ul><li>Faites réparer chez un couturier ou retoucheur.</li><li><a href="https://quefairedemesdechets.ademe.fr/bonus-reparation/" target="_blank" rel="noopener noreferrer">Bonus Réparation</a>\u00a0: jusqu\u2019à 25\u00a0\u20ac de la facture.</li></ul>', condition: 'Réparable' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Déposez vos vêtements propres et secs dans un conteneur à textiles ou en déchèterie, dans un sac fermé.</li><li>Même abîmés, ils seront recyclés en chiffons ou isolants.</li><li>Les textiles mouillés, souillés ou contaminés chimiquement vont en déchèterie uniquement.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'livres',
          nom: 'Livres',
          url: 'https://quefairedemesdechets.ademe.fr/categories/livres/',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/carte-assistant-sauf-pret-et-location/?action_displayed=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=96&sc_id=277',
          infoTri: ['livres-1.svg', 'livres-2.svg'],
          infoTriSmall: true,
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Donnez à une association, structure de réemploi ou déposez dans une boîte à livres.</li><li>Revendez en librairie de seconde main, sur une plateforme entre particuliers ou via un service de reprise en ligne.</li></ul>', condition: 'En bon état' },
            { titre: 'Déposer au tri', icone: 'deposer', consigne: '<ul><li>Déposez vos livres abîmés avec les papiers et emballages, dans le bac, le sac ou le conteneur de tri.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'poeles-casseroles',
          nom: 'Poêles et casseroles',
          url: 'https://quefairedemesdechets.ademe.fr/categories/poeles-et-casseroles/',
          infoTri: 'poeles-casseroles.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/carte-assistant-sauf-pret-et-location/?action_displayed=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=reparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=350',
          accordeons: [
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Donnez à une association ou structure de réemploi.</li><li>Revendez d\u2019occasion, à l\u2019unité ou en lot.</li></ul>', condition: 'En bon état' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Apportez dans un point de collecte (bureaux de Poste, déchèteries, enseignes spécialisées).</li><li>En dernier recours, jetez aux ordures ménagères.</li><li>Le recyclage de l\u2019aluminium économise 95\u00a0% d\u2019énergie par rapport à sa production.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        },
        {
          id: 'sapin-de-noel',
          nom: 'Sapin de Noël',
          url: 'https://quefairedemesdechets.ademe.fr/categories/biodechets/sapin-de-noel/',
          infoTri: 'sapin-de-noel.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/ass-deposer-uniquement/?sc_id=268',
          accordeons: [
            { titre: 'Sapin naturel', icone: 'deposer', consigne: '<ul><li>Retirez toutes les décorations, guirlandes, boules et accessoires.</li><li>Déposez dans un point de collecte dédié ou en déchèterie (collectes organisées après les fêtes).</li><li>Broyez pour composter ou pailler autour des végétaux, si vous avez un jardin.</li><li>Replantez-le s\u2019il est en pot.</li></ul><p>⚠️ Les sapins floqués, colorés ou bombés de neige artificielle sont recouverts de produits chimiques et ne peuvent pas être recyclés\u00a0: déposez-les aux ordures ménagères ou en déchèterie (benne des encombrants).</p><p>🚫 Il est interdit de brûler les déchets verts chez soi.</p>', condition: null },
            { titre: 'Sapin artificiel', icone: 'donner', consigne: '<ul><li>En bon état\u00a0: conservez-le, revendez-le ou donnez-le.</li><li>Hors d\u2019usage\u00a0: déposez-le en déchèterie.</li></ul>', condition: null }
          ]
        },
        {
          id: 'brique-alimentaire',
          nom: 'Brique alimentaire (jus, lait…)',
          url: 'https://quefairedemesdechets.ademe.fr/dechet/brique-alimentaire-jus-lait/',
          infoTri: 'brique-alimentaire.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/product/?sc_id=276',
          directDisplay: true,
          accordeons: [
            { titre: 'Déposer au tri', icone: 'trier', consigne: '<ul><li>Déposez la brique vide (inutile de la rincer) dans le bac, le sac ou le conteneur de tri.</li><li>Le carton sera recyclé en essuie-tout ou boîtes.</li><li>Le mélange plastique-aluminium servira au mobilier urbain ou à la valorisation énergétique.</li><li>Privilégiez les grands formats ou le vrac pour réduire les emballages.</li></ul>', condition: null }
          ]
        },
        {
          id: 'gros-electromenager',
          nom: 'Gros électroménager',
          url: 'https://quefairedemesdechets.ademe.fr/categories/gros-electromenager/',
          infoTri: 'gros-electromenager.svg',
          carteIframeSrc: 'https://quefairedemesdechets.ademe.fr/carte/tous-les-gestes/?action_displayed=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&action_list=preter%7Cmettreenlocation%7Creparer%7Ctrier%7Cdonner%7Cechanger%7Crevendre&sc_id=87',
          accordeons: [
            { titre: 'Réparer', icone: 'reparer', consigne: '<ul><li>Faites réparer pour utiliser plus longtemps et économiser.</li><li><a href="https://quefairedemesdechets.ademe.fr/bonus-reparation/" target="_blank" rel="noopener noreferrer">Bonus Réparation</a>\u00a0: jusqu\u2019à 50\u00a0\u20ac de la facture.</li><li>Pensez à l\u2019entretien régulier\u00a0: 50 à 70\u00a0% des pannes sont causées par un manque d\u2019entretien.</li></ul>', condition: 'Réparable' },
            { titre: 'Donner ou revendre', icone: 'donner', consigne: '<ul><li>Donnez à une association ou structure de réemploi (enlèvement à domicile parfois proposé).</li><li>Revendez en dépôt-vente ou sur une plateforme de seconde main.</li></ul>', condition: 'En bon état' },
            { titre: 'Déposer', icone: 'deposer', consigne: '<ul><li>Déposez en magasin (bac de collecte, remise au vendeur ou au livreur lors d\u2019un remplacement).</li><li>Apportez en déchèterie dans la benne DEEE.</li></ul>', condition: 'Hors d\u2019usage' }
          ]
        }
      ]
    };

    // =============================================
    // Navigation entre étapes
    // =============================================
    function goToStep2(ficheId) {
      const fiche = fichesData.find(f => f.id === ficheId);
      if (!fiche) return;

      appState.currentStep = 'territory';
      appState.selectedFiche = fiche;
      appState.selectedAddress = null;

      // Mettre à jour le chip
      selectedChipLabel.textContent = fiche.nom;

      // Mettre à jour les stats
      updateStatsDisplay();

      // Nettoyer l'adresse
      addressInput.value = '';
      addressResults.classList.remove('is-visible');
      addressResults.innerHTML = '';

      // Basculer la vue
      container.classList.remove('search-active');
      searchPanel.classList.remove('is-open');
      container.classList.add('step-territory');

      // Scroll en haut
      window.scrollTo(0, 0);

      // Focus sur le champ adresse
      setTimeout(() => addressInput.focus(), 150);

      // Historique navigateur
      history.pushState({ step: 'territory', ficheId: ficheId }, '');
    }

    function goToStep1() {
      appState.currentStep = 'search';
      appState.selectedFiche = null;
      appState.selectedAddress = null;
      appState.searchOrigin = 'home';

      // Basculer la vue
      container.classList.remove('step-territory');
      container.classList.remove('search-active');
      searchPanel.classList.remove('is-open');

      // Scroll en haut
      window.scrollTo(0, 0);

      // Focus sur le champ de recherche
      setTimeout(() => {
        searchInput.value = '';
        searchInput.focus();
      }, 150);
    }

    // Ouvrir la recherche depuis l'étape 2 (chip cliqué)
    function openSearchFromTerritory() {
      appState.searchOrigin = 'territory';

      // Masquer l'étape 2, montrer la recherche
      container.classList.remove('step-territory');
      container.classList.add('search-active');
      searchPanel.classList.add('is-open');

      // Réinitialiser l'affichage des éléments de recherche facilitée
      searchResults.classList.remove('is-visible');
      searchResults.innerHTML = '';
      searchCategories.style.display = '';
      searchPopular.style.display = '';

      // Scroll en haut
      window.scrollTo(0, 0);

      // Focus et vider le champ
      setTimeout(() => {
        searchInput.value = '';
        searchInput.focus();
      }, 150);
    }

    // Fermer la recherche et revenir à l'étape 2 (sans changer de fiche)
    function closeSearchBackToTerritory() {
      container.classList.remove('search-active');
      searchPanel.classList.remove('is-open');
      searchResults.classList.remove('is-visible');
      searchResults.innerHTML = '';
      searchInput.value = '';

      // Réafficher l'étape 2
      container.classList.add('step-territory');
      appState.searchOrigin = 'home';
    }

    // Gestion du bouton retour navigateur
    window.addEventListener('popstate', (e) => {
      if (e.state && e.state.step === 'fiche') {
        const fiche = fichesData.find(f => f.id === e.state.ficheId);
        if (fiche) {
          appState.selectedFiche = fiche;
          appState.selectedAddress = e.state.address;
          appState.currentStep = 'fiche';
          container.classList.remove('step-territory', 'search-active');
          container.classList.add('step-fiche');
          renderFiche();
        }
      } else if (e.state && e.state.step === 'territory') {
        container.classList.remove('step-fiche');
        goToStep2(e.state.ficheId);
      } else {
        appState.currentStep = 'search';
        appState.selectedFiche = null;
        container.classList.remove('step-territory', 'step-fiche');
      }
    });

    // =============================================
    // Statistiques dynamiques
    // =============================================
    function updateStatsDisplay() {
      const ficheId = appState.selectedFiche?.id;
      if (!ficheId || !appState.categoryCounts) return;

      const counts = appState.categoryCounts.national[ficheId] || {
        lieux: 0,
        services_a_domicile: 0,
        solutions_en_ligne: 0
      };

      const total = counts.lieux + counts.services_a_domicile + counts.solutions_en_ligne;

      const introEl = document.getElementById('territory-stats-intro');
      introEl.innerHTML = `<strong>${formatNumber(total)}\u00a0solutions</strong> d\u00e9j\u00e0 d\u00e9tect\u00e9es dans toute la France pour votre recherche. Affinez votre recherche pour trouver les r\u00e9sultats les plus pertinents pour vous.`;

      document.getElementById('stat-lieux').textContent = formatNumber(counts.lieux);
      document.getElementById('stat-services').textContent = formatNumber(counts.services_a_domicile);
      document.getElementById('stat-en-ligne').textContent = formatNumber(counts.solutions_en_ligne);
    }

    // =============================================
    // Logique de recherche (Étape 1)
    // =============================================
    function openSearchPanel() {
      // Si on n'est pas déjà en mode "vient de territory", c'est un accès depuis l'accueil
      if (appState.currentStep !== 'territory') {
        appState.searchOrigin = 'home';
      }
      searchPanel.classList.add('is-open');
      container.classList.add('search-active');

      // S'assurer que les catégories et populaires sont visibles (reset état précédent)
      if (!searchInput.value.trim()) {
        searchCategories.style.display = '';
        searchPopular.style.display = '';
      }
    }

    function closeSearchPanel() {
      searchPanel.classList.remove('is-open');
      container.classList.remove('search-active');
      searchResults.classList.remove('is-visible');
      searchResults.innerHTML = '';
    }

    function performSearch(query) {
      const normalizedQuery = normalize(query);

      if (normalizedQuery.length < 2) {
        searchResults.classList.remove('is-visible');
        searchResults.innerHTML = '';
        searchCategories.style.display = '';
        searchPopular.style.display = '';
        return;
      }

      const results = [];

      fichesData.forEach(fiche => {
        if (normalize(fiche.nom).includes(normalizedQuery)) {
          results.push({ nom: fiche.nom, id: fiche.id, score: 1 });
          return;
        }
        const matchingKeyword = fiche.keywords.find(kw => normalize(kw).includes(normalizedQuery));
        if (matchingKeyword) {
          results.push({ nom: matchingKeyword.charAt(0).toUpperCase() + matchingKeyword.slice(1), id: fiche.id, score: 2 });
        }
      });

      results.sort((a, b) => a.score - b.score);

      const seen = new Set();
      const uniqueResults = results.filter(r => {
        if (seen.has(r.id)) return false;
        seen.add(r.id);
        return true;
      });

      if (uniqueResults.length > 0) {
        const arrowSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg>';
        searchResults.innerHTML = uniqueResults.map(r =>
          `<li class="search-results__item" data-fiche-id="${r.id}" role="button" tabindex="0">
            <span class="search-results__name">${r.nom}</span>
            <span class="search-results__arrow" aria-hidden="true">${arrowSvg}</span>
          </li>`
        ).join('');
        searchResults.classList.add('is-visible');
        searchCategories.style.display = 'none';
        searchPopular.style.display = 'none';
      } else {
        searchResults.classList.remove('is-visible');
        searchResults.innerHTML = '';
        searchCategories.style.display = '';
        searchPopular.style.display = '';
      }
    }

    // =============================================
    // Événements recherche (Étape 1)
    // =============================================
    searchInput.addEventListener('focus', () => {
      openSearchPanel();
    });

    searchInput.addEventListener('input', (e) => {
      performSearch(e.target.value);
    });

    // Clic sur un résultat de recherche
    searchResults.addEventListener('click', (e) => {
      const item = e.target.closest('.search-results__item');
      if (item && item.dataset.ficheId) {
        closeSearchPanel();
        searchInput.value = '';
        goToStep2(item.dataset.ficheId);
      }
    });

    // Clavier sur un résultat de recherche
    searchResults.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const item = e.target.closest('.search-results__item');
        if (item && item.dataset.ficheId) {
          e.preventDefault();
          closeSearchPanel();
          searchInput.value = '';
          goToStep2(item.dataset.ficheId);
        }
      }
    });

    // Clic sur une carte catégorie
    document.querySelector('.search-categories__grid').addEventListener('click', (e) => {
      const card = e.target.closest('.category-card');
      if (card && card.dataset.category) {
        closeSearchPanel();
        searchInput.value = '';
        goToStep2(card.dataset.category);
      }
    });

    // Clic sur un item populaire
    document.querySelector('.search-popular__list').addEventListener('click', (e) => {
      const item = e.target.closest('.search-popular__item');
      if (item && item.dataset.ficheId) {
        closeSearchPanel();
        searchInput.value = '';
        goToStep2(item.dataset.ficheId);
      }
    });

    // Clavier sur un item populaire
    document.querySelector('.search-popular__list').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const item = e.target.closest('.search-popular__item');
        if (item && item.dataset.ficheId) {
          e.preventDefault();
          closeSearchPanel();
          searchInput.value = '';
          goToStep2(item.dataset.ficheId);
        }
      }
    });

    // Bouton croix pour fermer le panneau de recherche (contextuel)
    document.getElementById('search-panel-close').addEventListener('click', () => {
      if (appState.searchOrigin === 'territory') {
        // Vient de l'étape 2 → retour à l'étape 2
        closeSearchBackToTerritory();
      } else {
        // Vient de l'accueil → fermer le panneau
        closeSearchPanel();
        searchInput.value = '';
      }
    });

    // Fermer quand on clique en dehors
    document.addEventListener('click', (e) => {
      const isInsideSearch = e.target.closest('.search-section') || e.target.closest('.search-panel');
      if (!isInsideSearch && searchPanel.classList.contains('is-open')) {
        closeSearchPanel();
        searchInput.value = '';
      }
    });

    // =============================================
    // Chip (Étape 2 → ouvre la recherche)
    // =============================================
    selectedChip.addEventListener('click', () => {
      openSearchFromTerritory();
    });

    // =============================================
    // API BAN — Autocomplétion d'adresse
    // =============================================
    let addressDebounceTimer = null;
    let addressFocusedIndex = -1;

    addressInput.addEventListener('input', (e) => {
      clearTimeout(addressDebounceTimer);
      const query = e.target.value.trim();

      if (query.length < 3) {
        addressResults.classList.remove('is-visible');
        addressResults.innerHTML = '';
        addressFocusedIndex = -1;
        return;
      }

      addressDebounceTimer = setTimeout(() => {
        fetchAddressSuggestions(query);
      }, 300);
    });

    async function fetchAddressSuggestions(query) {
      try {
        const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5&autocomplete=1`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.features && data.features.length > 0) {
          addressResults.innerHTML = data.features.map((feature, index) => {
            const props = feature.properties;
            const coords = feature.geometry.coordinates;
            return `<li class="address-results__item"
                        role="option"
                        data-label="${props.label}"
                        data-citycode="${props.citycode || ''}"
                        data-postcode="${props.postcode || ''}"
                        data-lon="${coords[0]}"
                        data-lat="${coords[1]}"
                        tabindex="-1">${props.label}</li>`;
          }).join('');
          addressResults.classList.add('is-visible');
          addressFocusedIndex = -1;
        } else {
          addressResults.classList.remove('is-visible');
          addressResults.innerHTML = '';
        }
      } catch (error) {
        console.error('Erreur API BAN:', error);
      }
    }

    // Sélection d'une adresse
    addressResults.addEventListener('click', (e) => {
      const item = e.target.closest('.address-results__item');
      if (item) {
        selectAddress(item);
      }
    });

    function selectAddress(item) {
      appState.selectedAddress = {
        label: item.dataset.label,
        citycode: item.dataset.citycode,
        postcode: item.dataset.postcode,
        lat: parseFloat(item.dataset.lat),
        lon: parseFloat(item.dataset.lon)
      };
      addressInput.value = item.dataset.label;
      addressResults.classList.remove('is-visible');
      addressResults.innerHTML = '';
      addressFocusedIndex = -1;

      // Passer automatiquement à l'étape 3
      goToStep3();
    }

    // Navigation clavier dans l'autocomplétion
    addressInput.addEventListener('keydown', (e) => {
      const items = addressResults.querySelectorAll('.address-results__item');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        addressFocusedIndex = Math.min(addressFocusedIndex + 1, items.length - 1);
        updateAddressFocus(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        addressFocusedIndex = Math.max(addressFocusedIndex - 1, 0);
        updateAddressFocus(items);
      } else if (e.key === 'Enter' && addressFocusedIndex >= 0) {
        e.preventDefault();
        selectAddress(items[addressFocusedIndex]);
      } else if (e.key === 'Escape') {
        addressResults.classList.remove('is-visible');
        addressFocusedIndex = -1;
      }
    });

    function updateAddressFocus(items) {
      items.forEach((item, i) => {
        item.classList.toggle('is-focused', i === addressFocusedIndex);
      });
    }

    // Fermer l'autocomplétion quand on clique en dehors
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.territory-search')) {
        addressResults.classList.remove('is-visible');
        addressFocusedIndex = -1;
      }
    });

    // =============================================
    // Étape 3 — Fiche résultat
    // =============================================
    function goToStep3() {
      if (!appState.selectedFiche || !appState.selectedAddress) return;

      appState.currentStep = 'fiche';

      // Basculer la vue
      container.classList.remove('step-territory', 'search-active');
      searchPanel.classList.remove('is-open');
      container.classList.add('step-fiche');

      // Rendre la fiche
      renderFiche();

      // Scroll en haut
      window.scrollTo(0, 0);

      // Historique navigateur
      history.pushState({
        step: 'fiche',
        ficheId: appState.selectedFiche.id,
        address: appState.selectedAddress
      }, '');
    }

    function goBackFromFiche() {
      appState.currentStep = 'territory';
      container.classList.remove('step-fiche');
      container.classList.add('step-territory');

      // Restaurer le chip et les stats de l'étape 2
      selectedChipLabel.textContent = appState.selectedFiche.nom;
      addressInput.value = appState.selectedAddress ? appState.selectedAddress.label : '';
      updateStatsDisplay();

      window.scrollTo(0, 0);
    }

    // Estimation locale : nombre de solutions dans un rayon de 10 km
    // Surface rayon 10km ≈ 314 km². France métropolitaine ≈ 640 000 km².
    // Ratio brut ≈ 0.049%. On applique un facteur de densité basé sur le département.
    function estimateLocalCount(nationalCount) {
      // Facteur moyen : entre 0.05% (rural) et 0.3% (grande ville)
      // On utilise un facteur médian réaliste de 0.12%
      const localRatio = 0.0012;
      return Math.max(1, Math.round(nationalCount * localRatio));
    }

    function renderFiche() {
      const ficheId = appState.selectedFiche.id;
      const address = appState.selectedAddress;

      // Trouver les consignes
      const consigneFiche = appState.consignesData
        ? appState.consignesData.fiches.find(f => f.id === ficheId)
        : null;

      // Trouver les comptages nationaux
      const counts = appState.categoryCounts
        ? appState.categoryCounts.national[ficheId] || { lieux: 0, services_a_domicile: 0, solutions_en_ligne: 0 }
        : { lieux: 0, services_a_domicile: 0, solutions_en_ligne: 0 };

      // Estimation locale à 10 km
      const localLieux = estimateLocalCount(counts.lieux);
      const localServices = counts.services_a_domicile; // Les services à domicile couvrent tout le territoire
      const localEnLigne = counts.solutions_en_ligne;   // Les solutions en ligne aussi
      const localTotal = localLieux + localServices + localEnLigne;

      // --- En-tête ---
      document.getElementById('fiche-object-name').textContent = appState.selectedFiche.nom;
      document.getElementById('fiche-object-address').textContent = address ? address.label : '';
      document.getElementById('fiche-total-solutions').textContent =
        `Super, ${formatNumber(localTotal)}\u00a0solutions ont été trouvées\u00a0!`;

      // --- Info-tri ---
      const infoTriContainer = document.getElementById('fiche-infotri-images');
      const infoTriSection = document.getElementById('fiche-infotri');
      infoTriContainer.innerHTML = '';

      if (consigneFiche && consigneFiche.infoTri) {
        infoTriSection.style.display = '';
        const infoTris = Array.isArray(consigneFiche.infoTri) ? consigneFiche.infoTri : [consigneFiche.infoTri];
        infoTris.forEach(src => {
          const img = document.createElement('img');
          img.src = 'src/assets/info-tri/' + src;
          img.alt = 'Info-tri pour ' + appState.selectedFiche.nom;
          img.className = 'fiche-infotri__img' + (consigneFiche.infoTriSmall ? ' fiche-infotri__img--small' : '');
          img.loading = 'lazy';
          infoTriContainer.appendChild(img);
        });
      } else {
        infoTriSection.style.display = 'none';
      }

      // --- Accordéons ---
      const accordeonsContainer = document.getElementById('fiche-accordeons');
      accordeonsContainer.innerHTML = '';

      if (consigneFiche && consigneFiche.accordeons) {
        const chevronSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';

        // Répartir les lieux locaux entre les accordéons proportionnellement
        const nbAccordeons = consigneFiche.accordeons.length;
        const lieuxParAccordeon = [];
        let lieuxRestants = localLieux;
        consigneFiche.accordeons.forEach((acc, i) => {
          if (i === nbAccordeons - 1) {
            lieuxParAccordeon.push(lieuxRestants);
          } else {
            // Répartition dégressive : le premier accordéon a le plus de solutions
            const share = Math.max(1, Math.round(localLieux * (nbAccordeons - i) / ((nbAccordeons * (nbAccordeons + 1)) / 2)));
            lieuxParAccordeon.push(share);
            lieuxRestants -= share;
          }
        });

        consigneFiche.accordeons.forEach((acc, index) => {
          const nbSolutions = lieuxParAccordeon[index];
          const subtitleHtml = `<span class="fiche-accordion__subtitle">${formatNumber(nbSolutions)} solutions identifiées</span>`;

          const conditionBadge = acc.condition
            ? `<span class="fiche-accordion__condition">${acc.condition}</span>`
            : '';

          if (consigneFiche.directDisplay) {
            // Affichage direct sans accordéon (seringue, brique alimentaire…)
            const section = document.createElement('div');
            section.className = 'fiche-direct-section';
            section.innerHTML = `
              <span class="fiche-accordion__title">${acc.titre}</span>
              ${subtitleHtml}
              ${conditionBadge}
              <div class="fiche-accordion__consigne">${acc.consigne}</div>
            `;
            accordeonsContainer.appendChild(section);
          } else {
            const details = document.createElement('details');
            details.className = 'fiche-accordion';

            details.innerHTML = `
              <summary class="fiche-accordion__header" aria-expanded="false">
                <div class="fiche-accordion__header-left">
                  <span class="fiche-accordion__title">${acc.titre}</span>
                  ${subtitleHtml}
                </div>
                <span class="fiche-accordion__icon" aria-hidden="true">${chevronSvg}</span>
              </summary>
              <div class="fiche-accordion__content">
                ${conditionBadge}
                <div class="fiche-accordion__consigne">${acc.consigne}</div>
              </div>
            `;

            // Toggle aria-expanded
            details.addEventListener('toggle', () => {
              const summary = details.querySelector('.fiche-accordion__header');
              summary.setAttribute('aria-expanded', details.open ? 'true' : 'false');
            });

            accordeonsContainer.appendChild(details);
          }
        });
      }

      // --- Avertissements ---
      const warningsSection = document.getElementById('fiche-warnings');
      const warningsList = document.getElementById('fiche-warnings-list');
      warningsList.innerHTML = '';

      const warnings = consigneFiche ? consigneFiche.avertissements || [] : [];
      if (warnings.length > 0) {
        warningsSection.style.display = '';
        const warnIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="fiche-warnings__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
        warnings.forEach(w => {
          const li = document.createElement('li');
          li.className = 'fiche-warnings__item';
          li.innerHTML = warnIconSvg + '<span>' + w + '</span>';
          warningsList.appendChild(li);
        });
      } else {
        warningsSection.style.display = 'none';
      }

      // --- Card alerte DSFR (médicaments, etc.) ---
      const existingCardAlert = document.querySelector('.fiche-card-alert');
      if (existingCardAlert) existingCardAlert.remove();

      if (consigneFiche && consigneFiche.cardAlert) {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'fiche-card-alert';
        cardDiv.innerHTML = '<p class="fiche-card-alert__title">Attention</p><div class="fiche-card-alert__content">' + consigneFiche.cardAlert + '</div>';
        warningsSection.insertAdjacentElement('afterend', cardDiv);
      }

      // --- Carte ---
      const mapContainer = document.getElementById('fiche-map-container');
      mapContainer.innerHTML = '';

      if (consigneFiche && consigneFiche.carteIframeSrc) {
        // Carte spécifique QFDMO (iframe préfiltrée par objet)
        let carteSrc = consigneFiche.carteIframeSrc;

        // Pré-remplir l'adresse saisie à l'étape 2 dans la carte
        if (appState.selectedAddress && appState.selectedAddress.lat) {
          // Extraire le préfixe du type de carte depuis l'URL (ex: "tous-les-gestes", "product", etc.)
          const carteMatch = carteSrc.match(/\/carte\/([^/?]+)/);
          if (carteMatch) {
            const prefix = carteMatch[1];
            const separator = carteSrc.includes('?') ? '&' : '?';
            carteSrc += separator
              + encodeURIComponent(prefix + '_map-adresse') + '=' + encodeURIComponent(appState.selectedAddress.label)
              + '&' + encodeURIComponent(prefix + '_map-latitude') + '=' + encodeURIComponent(appState.selectedAddress.lat)
              + '&' + encodeURIComponent(prefix + '_map-longitude') + '=' + encodeURIComponent(appState.selectedAddress.lon);
          }
        }

        const mapIframe = document.createElement('iframe');
        mapIframe.src = carteSrc;
        mapIframe.title = 'Carte des solutions pour ' + appState.selectedFiche.nom;
        mapIframe.style.width = '100%';
        mapIframe.style.height = '600px';
        mapIframe.style.border = 'none';
        mapIframe.loading = 'lazy';
        mapIframe.setAttribute('allow', 'geolocation');
        mapContainer.appendChild(mapIframe);
      } else {
        // Fallback : carte LVAO générique
        const iconeToActions = {
          'donner': ['donner', 'echanger', 'revendre', 'acheter'],
          'reparer': ['reparer'],
          'louer': ['preter', 'emprunter', 'louer', 'mettreenlocation'],
          'deposer': ['donner', 'echanger', 'revendre', 'acheter'],
          'trier': ['donner', 'echanger', 'revendre', 'acheter']
        };

        const lvaoActions = new Set();
        if (consigneFiche && consigneFiche.accordeons) {
          consigneFiche.accordeons.forEach(acc => {
            const actions = iconeToActions[acc.icone];
            if (actions) actions.forEach(a => lvaoActions.add(a));
          });
        }

        const allActions = 'preter|emprunter|louer|mettreenlocation|reparer|donner|echanger|acheter|revendre';
        const actionList = lvaoActions.size > 0 ? Array.from(lvaoActions).join('|') : allActions;

        const mapScript = document.createElement('script');
        mapScript.src = 'https://lvao.ademe.fr/static/carte.js';
        mapScript.dataset.action_list = actionList;

        if (appState.selectedAddress && appState.selectedAddress.lat && appState.selectedAddress.lon) {
          const lat = appState.selectedAddress.lat;
          const lon = appState.selectedAddress.lon;
          const offset = 0.045;
          const boundingBox = {
            southWest: { lat: lat - offset, lng: lon - offset },
            northEast: { lat: lat + offset, lng: lon + offset }
          };
          mapScript.dataset.bounding_box = JSON.stringify(boundingBox);
        }

        mapContainer.appendChild(mapScript);
      }

      // --- Solutions à domicile / en ligne ---
      const ficheUrl = consigneFiche ? consigneFiche.url : '#';

      document.getElementById('fiche-sol-domicile-desc').textContent =
        `Nous avons trouvé ${formatNumber(localServices)} solutions. Des solutions existent pour venir jusqu'à chez vous\u00a0!`;
      document.getElementById('fiche-sol-domicile-link').href = ficheUrl;

      document.getElementById('fiche-sol-enligne-desc').textContent =
        `Nous avons trouvé ${formatNumber(localEnLigne)} solutions. Explorez l'ensemble des sites Internet et solutions en ligne pour votre objet.`;
      document.getElementById('fiche-sol-enligne-link').href = ficheUrl;
    }

    // Bouton retour depuis la fiche
    document.getElementById('fiche-back-chip').addEventListener('click', () => {
      goBackFromFiche();
    });

    // =============================================
    // Gestion de l'accordéon
    // =============================================
    document.querySelectorAll('.accordion').forEach(details => {
      details.addEventListener('toggle', () => {
        const summary = details.querySelector('.accordion__header');
        summary.setAttribute('aria-expanded', details.open ? 'true' : 'false');
      });
    });

    // =============================================
    // Auto-resize iframe : envoie la hauteur au parent
    // =============================================
    (function() {
      if (window.self === window.top) return; // Pas dans une iframe

      // Désactiver le scroll interne
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';

      function sendHeight() {
        var height = document.documentElement.scrollHeight;
        window.parent.postMessage({ type: 'assistant-tri-resize', height: height }, '*');
      }

      // Observer les changements de taille du contenu
      var ro = new ResizeObserver(function() { sendHeight(); });
      ro.observe(document.body);

      // Envoyer aussi au chargement et après les transitions
      sendHeight();
      window.addEventListener('load', sendHeight);
    })();
  </script>
</body>
</html>
